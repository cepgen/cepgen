name: linux
on:
  pull_request:
  push:
    branches: master
env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release
  INSTALL_PATH: /
  LD_LIBRARY_PATH: /Package/install/lib64:$LD_LIBRARY_PATH
  NUM_BUILD_CORES: 8
  CG_CI: 1
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: Fedora 37
            CI_IMAGE: 'laufor/ci-images:cepgen-fedora37'
            cmakeExec: cmake3
            packageInstall: [sudo dnf install -y /Package/build/*.rpm]
          - id: CC7
            CI_IMAGE: 'laufor/ci-images:cepgen-cc7'
            cmakeExec: cmake3
            extraCommands: source scl_source enable devtoolset-8 || echo ignoring exit code so CI does not bomb when it should not > /dev/null
          - id: Ubuntu 20.04
            CI_IMAGE: 'laufor/ci-images:cepgen-ubuntu20'
            cmakeExec: cmake
            packageInstall: |
              sudo apt-get install -y /Package/build/*.deb
    container:
      image: ${{ matrix.CI_IMAGE }}
      #volumes:
        #- /cvmfs:/cvmfs:shared
      options: -v ${{ github.workspace }}:/Package
    steps:
      - uses: actions/checkout@v3
      #- uses: cvmfs-contrib/github-action-cvmfs@v2
      - name: CMake configuration
        run: |
          ${{ matrix.extraCommands }}
          cd /Package
          echo "${{ env.INSTALL_PATH }}/bin" >> $GITHUB_PATH
          mkdir -p build/ install/
          cd build
          ${{ matrix.cmakeExec }} -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_PATH }} -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DCMAKE_CXX_FLAGS=" -fdiagnostics-color=always" ..
      - name: Install
        run: |
          ${{ matrix.extraCommands }}
          cd /Package/build
          make -j ${{ env.NUM_BUILD_CORES }} install
      - name: Testing cepgen executable
        run: |
          ${{ matrix.extraCommands }}
          cd /Package/build
          #valgrind --show-leak-kinds=all --leak-check=full bin/cepgen Cards/lpair_cfg.py
          bin/cepgen Cards/lpair_cfg.py
      - name: Generate cepgen package
        run: |
          ${{ matrix.extraCommands }}
          cd /Package
          cd build
          make -j ${{ env.NUM_BUILD_CORES }} package
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: package
          path: ${{ github.workspace }}/build/*.rpm
      - name: Testing cepgen executable (packaged)
        continue-on-error: ${{ matrix.CI_IMAGE == 'laufor/ci-images:cepgen-cc7' }}
        run: |
          ${{ matrix.packageInstall }}
          echo -e "Now running cepgen installed from rpm"
          valgrind --show-leak-kinds=all --leak-check=full cepgen Cards/lpair_cfg.py
      - name: Testing CI recipes
        run: |
          ${{ matrix.extraCommands }}
          cd /Package/build
          make -j ${{ env.NUM_BUILD_CORES }} && ctest --output-on-failure

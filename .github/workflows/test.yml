name: linux
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v2
      - uses: cvmfs-contrib/github-action-cvmfs@v2
      - name: Start container
        run: |
          docker run -it --name CI_container -v ${GITHUB_WORKSPACE}:/Package -v /cvmfs:/cvmfs:shared -d ghcr.io/aidasoft/centos7:latest /bin/bash
      - name: CMake configuration
        run: |
          docker exec CI_container /bin/bash -c 'cd Package;\
            mkdir -p build/ install/;\
            cd build;\
            cmake -DCMAKE_INSTALL_PREFIX=../install -DCMAKE_CXX_FLAGS=" -fdiagnostics-color=always " -GNinja ..;'
      - name: Build
        run: |
          docker exec CI_container /bin/bash -c 'cd Package;\
            cd build;\
            ninja -k0;'
      - name: Install
        run: |
          docker exec CI_container /bin/bash -c 'cd Package;\
            cd build;\
            ninja -k0 install;'
      - name: Testing cepgen executable
        run: |
          docker exec CI_container /bin/bash -c 'cd Package;\
            cd build;\
            ./cepgen Cards/lpair_cfg.py;'
      - name: Testing CI recipes
        run: |
          docker exec CI_container /bin/bash -c 'cd Package;\
            cd build;\
            ninja -k0 && ctest --output-on-failure;'

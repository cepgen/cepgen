name: documentation
on:
  push:
    branches: doc-sphinx
jobs:
  doc:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    container:
      image: 'laufor/ci-images:cepgen-fedora37'
      options: -v ${{ github.workspace }}:/Package
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2000
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: 'just-a-placeholder-so-we-dont-get-errors'
      - name: Add known hosts
        run: mkdir -p ~/.ssh && ssh-keyscan -p 222 -H login.hepforge.org >> ~/.ssh/known_hosts
      - name: Python requirements
        run: |
          cd /Package
          sudo pip install -r requirements.txt
      - name: CMake configuration
        run: |
          git config --global --add safe.directory /Package
          cd /Package
          mkdir -p build/ install/
          cd build
          cmake3 -DCMAKE_BUILD_UTILS=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS=" -fdiagnostics-color=always" ..
      - name: Generate cepgen documentation
        run: |
          cd /Package/build
          make -j 8 cepgenDocGenerator && ./bin/cepgenDocGenerator -o ../doc/.raw_modules.html -e
          make Sphinx
      - name: Upload documentation
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -arvz --delete -O -q
          path: build/doc/output_html/
          remote_path: ~/cepgen/public_html/
          remote_host: login.hepforge.org
          remote_port: 222
          remote_user: ${{ secrets.SSH_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

stages:
  - compile
  - test
  - run

image: gitlab-registry.cern.ch/lforthom/custom_ci_worker:cc7

compile:
  stage: compile
  before_script:
    - mkdir build
    - cd build
  script:
    - cmake -DCMAKE_BUILD_TESTS=1 ..
    - make -j 4
  artifacts:
    expire_in: 2 hrs
    paths:
      - build/

# define all tests

test:
  stage: test
  dependencies:
    - compile
  script:
    - cd build
    - make test
  when: on_success
  allow_failure: false

test_integrator:
  stage: test
  dependencies:
    - compile
  script:
    - cd build
    - make test_integrator
    - test/test_integrator -i vegas
    - test/test_integrator -i miser
  when: on_success
  allow_failure: false

test_cross_sections:
  stage: test
  dependencies:
    - compile
  script:
    - cd build
    - make test_physics_processes
    - test/test_physics_processes -i vegas
    - test/test_physics_processes -i miser
  when: on_success
  allow_failure: true

test_function_parser:
  stage: test
  dependencies:
    - compile
  script:
    - cd build
    - make test_function_parser test_function_parser_rootcomp
    - test/test_function_parser
    - test/test_function_parser_rootcomp
  when: on_success
  allow_failure: false

run_cepgen:
  stage: run
  dependencies:
    - compile
  script:
    - cd build
    - make -j 4 cepgen
    - ./cepgen Cards/lpair_cfg.py
    - ./cepgen Cards/legacy/lpair.card
  when: on_success
  allow_failure: false

